# 数据洞察模块 (datafact_generator)

数据洞察模块（`datafact_generator`）是 ChartPipeline 框架的第二个处理环节，负责分析数据并提取关键洞察，用于增强可视化的信息价值。

## 功能简介

本模块通过统计分析和模式识别，从数据中提取有意义的洞察（datafacts），包括趋势、比例关系、显著差异、异常值等。这些洞察按重要性排序，可用于指导可视化设计和标注，强化数据叙事。

## 输入与输出

### 输入

模块接收包含 `chart_type` 字段的数据对象，主要关注：

- `data.columns`: 列定义
- `data.data`: 实际数据记录
- `chart_type`: 图表类型推荐结果

### 输出

模块向输入数据添加 `datafacts` 字段，结构如下：

```json
{
  "datafacts": [
    {
      "type": "trend",
      "score": 0.95,
      "annotation": "紧急状态宣布数量总体呈上升趋势",
      "reason": "从1976年至2022年，每十年宣布的国家紧急状态总数从1个增长到平均每十年超过15个"
    },
    {
      "type": "proportion",
      "score": 0.92,
      "annotation": "2010年代83%的紧急状态仍然活跃",
      "reason": "在2010-2019期间宣布的18个紧急状态中，15个仍处于活跃状态，只有3个已结束"
    },
    {
      "type": "difference",
      "score": 0.88,
      "annotation": "90年代结束的紧急状态最多",
      "reason": "1990-1999年期间有14个紧急状态被结束，是所有时期中最高的"
    },
    {
      "type": "trend",
      "score": 0.85,
      "annotation": "结束的紧急状态比例逐年减少",
      "reason": "从1980年代的100%结束率到2020年代仅11%的结束率，显示出明显下降趋势"
    },
    {
      "type": "value",
      "score": 0.82,
      "annotation": "总计41个紧急状态仍然活跃",
      "reason": "所有时期加总，仍处于活跃状态的紧急状态数量为41个，远高于已结束的30个"
    }
  ]
}
```

每个数据洞察包含以下字段：

| 字段 | 类型 | 描述 |
|------|------|------|
| `type` | 字符串 | 洞察类型 |
| `score` | 浮点数 | 重要性评分（0-1） |
| `annotation` | 字符串 | 简短的洞察描述，适合作为图表标注 |
| `reason` | 字符串 | 详细的解释和支持该洞察的数据依据 |

## 支持的洞察类型

模块能够识别以下类型的数据洞察：

- **trend（趋势）**: 数据随时间或序列变化的模式
- **proportion（比例）**: 部分与整体的关系
- **difference（差异）**: 数据组或类别间的显著差异
- **value（数值）**: 重要的单一数值或统计量
- **outlier（异常值）**: 显著偏离正常范围的数据点
- **correlation（相关性）**: 变量间的关系
- **distribution（分布）**: 数据分布的特征

## 实现方法

模块使用多种分析技术从数据中提取洞察：

1. **趋势分析**：使用回归分析、移动平均等方法识别时间序列趋势
2. **比例计算**：计算群组内部或整体的比例关系
3. **统计显著性测试**：使用t检验等方法检测组间差异
4. **异常检测**：使用Z-score、IQR等方法识别异常值
5. **相关性分析**：计算变量间的相关系数，识别强相关性

每个洞察的重要性评分基于多个因素计算：
- 统计显著性
- 效应大小
- 与主题相关性
- 洞察类型的一般重要性

## 适应图表类型

模块考虑推荐的图表类型，优先提取与该类型最相关的洞察。例如：
- 对于趋势图表，重点识别趋势和变化
- 对于比较图表，重点识别差异和对比
- 对于分布图表，重点识别分布特征和异常值

## 使用示例

### 命令行调用

```bash
python -m modules.datafact_generator.datafact_generator --input input_data.json --output output_data.json
```

### 程序调用

```python
from modules.datafact_generator.datafact_generator import process

success = process(input='input_data.json', output='output_data.json')
if success:
    print("数据洞察生成完成")
else:
    print("数据洞察生成失败")
```

## 扩展指南

如需增强数据洞察功能，可以：

1. 添加新的洞察类型和检测算法
2. 调整评分算法以适应特定领域需求
3. 为特定数据类型添加专门的分析方法

## 常见问题

**Q: 如何控制生成的洞察数量？**  
A: 模块默认返回评分最高的5个洞察，可以通过修改模块参数调整数量。

**Q: 洞察是如何排序的？**  
A: 洞察按评分（score）从高到低排序，评分反映该洞察的重要性和显著性。

**Q: 如何处理小数据集？**  
A: 对于小数据集，模块会调整统计方法以避免过度解读，并相应降低置信度。 