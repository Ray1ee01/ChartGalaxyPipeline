# 标题生成模块 (title_generator)

标题生成模块（`title_generator`）是 ChartPipeline 框架的第三个处理环节，负责基于数据内容和洞察生成有吸引力的标题和副标题。

## 功能简介

本模块通过分析数据洞察和图表类型，生成能够准确概括数据主题并突出关键发现的标题。生成的标题简洁明了，引人入胜，使读者能够迅速理解可视化内容的核心信息。

## 输入与输出

### 输入

模块接收包含以下字段的数据对象：

- `metadata`: 原始元数据（包含标题、描述等）
- `chart_type`: 图表类型推荐
- `datafacts`: 数据洞察

### 输出

模块向输入数据添加 `titles` 字段，结构如下：

```json
{
  "titles": {
    "main_title": "美国国家紧急状态持续增长",
    "sub_title": "1976年以来宣布的紧急状态中大多数仍然有效"
  }
}
```

输出字段说明：

| 字段 | 类型 | 描述 |
|------|------|------|
| `main_title` | 字符串 | 图表主标题，简洁地概括核心信息 |
| `sub_title` | 字符串 | 图表副标题，提供补充信息和上下文 |

## 实现方法：RAG-based 标题生成

本模块采用基于检索增强生成（Retrieval-Augmented Generation, RAG）的方法实现标题生成，主要包括以下技术点：

1. **向量化和相似度检索**: 使用SentenceBERT将输入数据转换为语义向量，并通过FAISS向量数据库高效检索相似样例
2. **数据预处理**: 将输入的图表数据、元数据和数据洞察组织成结构化文本
3. **相似案例检索**: 基于输入数据的语义特征，检索训练集中最相似的图表及其标题
4. **大模型增强生成**: 结合检索到的案例和当前数据特征，通过大语言模型生成适合的标题和副标题

### 核心组件

#### SentenceBERT 编码器

使用预训练的SentenceBERT模型（`all-MiniLM-L6-v2`）将文本内容转换为语义向量，以进行语义相似度比较。

#### FAISS 索引

高性能向量索引库，用于存储和检索训练数据的语义嵌入表示，支持高效的最近邻搜索。

#### 标题生成引擎

基于OpenAI的大语言模型，结合检索到的相似案例生成标题和副标题，确保生成内容符合主题、简洁明了且信息准确。

## 数据处理流程

### 训练数据处理

1. **数据预处理**: 处理输入数据，包括图表类型、列名、数据内容和数据洞察
2. **向量化**: 使用SentenceBERT将处理后的文本转换为向量表示
3. **索引构建**: 将向量及其对应的标题、描述信息保存到FAISS索引中

### 标题生成流程

1. **输入处理**: 将待生成标题的图表数据处理成与训练数据相同的格式
2. **向量化**: 对处理后的文本进行向量化
3. **相似案例检索**: 使用FAISS检索topk个最相似的案例
4. **提示词构建**: 将检索到的案例与当前输入组合成提示词
5. **标题生成**: 使用大语言模型基于提示词生成标题和副标题

## 数据洞察生成

模块能够从输入数据中识别和提取多种类型的数据洞察（Data Facts），包括：

1. **聚合类洞察**: 最大值、最小值、平均值、总和等聚合操作
2. **比较类洞察**: 两个数据点之间的差异比较
3. **趋势类洞察**: 时间序列数据的变化趋势
4. **合并类洞察**: 将多个相关的数据事实合并为一个
5. **组合类洞察**: 组合多个不同内容的数据事实
6. **概览类洞察**: 提供数据整体特征的概述

## 参数配置

模块支持以下参数配置：

| 参数 | 类型 | 描述 | 默认值 |
|------|------|------|--------|
| `topk` | 整数 | 检索最相似样例的数量 | 3 |
| `train_ratio` | 浮点数 | 训练集占比 | 0.8 |
| `index_path` | 字符串 | FAISS索引保存路径 | "faiss_infographics.index" |
| `data_path` | 字符串 | 训练数据保存路径 | "infographics_data.npy" |

## 评估方法

模块提供了基于BLEU得分的评估方法，用于测量生成标题与参考标题之间的相似度。评估过程包括：

1. **验证集划分**: 按比例将数据集划分为训练集和验证集
2. **RAG消融实验**: 通过调整topk值（0-9）评估检索案例数量对生成质量的影响
3. **BLEU评分**: 使用BLEU-4评分计算生成标题与参考标题的相似度

## 使用示例

### 初始化与训练

```python
from modules.title_generator.rag_title_generator import RagTitleGenerator

# 初始化生成器
generator = RagTitleGenerator(
    json_path="path/to/training_data.json",
    train_ratio=0.8
)

# 处理训练数据
generator.process_json()
```

### 生成标题

```python
# 准备输入数据
input_data = (image_name, {
    "chart_type": "line",
    "columns": [...],
    "data": [...],
    "data_facts": [...]
})

# 生成标题和描述
title, description = generator.generate_title_description(input_data, topk=3)
print(f"生成标题: {title}")
print(f"生成描述: {description}")
```

### 性能评估

```python
# 评估不同topk设置下的生成质量
bleu_score = generator.evaluate_bleu()
```
